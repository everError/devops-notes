## π“ λ¨λ‹ν„°λ§ νμ΄μ§€ μ¬λ°°ν¬ μ „λµ

### β… λ©ν‘

> μ¥μ•  μƒν™© (μ •μ  νμ΄μ§€ λ―Έμ κ³µ, API μ„λ²„ λ‹¤μ΄ λ“±)μ—μ„λ„ λ¨λ‹ν„°λ§ νμ΄μ§€κ°€ **μµλ€ν• λ¬΄μ¤‘λ‹¨μΌλ΅ λ™μ‘**ν•κ³ , μ¥μ• κ°€ λ°μƒν•΄λ„ **μ‚¬μ©μκ°€ λΉ λ¥΄κ² λ³µκµ¬λ¨μ„ μΈμ§€ν•κ±°λ‚ μλ™ λ³µκµ¬**λλ„λ΅ κµ¬μ„±ν•λ‹¤.

---

### β… κµ¬μ„± μ”μ†

| κµ¬μ„± μ”μ†                  | μ—­ν•                                                                                      |
| -------------------------- | ---------------------------------------------------------------------------------------- |
| **HAProxy (λ‹¨μΌ μ§„μ…μ )**  | `/` μ”μ²­μ€ μ •μ  νμΌ μ„λ²„λ΅, `/api/*` μ”μ²­μ€ API μ„λ²„λ΅ λΌμ°ν… + μƒνƒ κΈ°λ° failover μν–‰ |
| **μ •μ  νμΌ μ„λ²„ (Nginx)** | index.html, JS, CSS, μ΄λ―Έμ§€ μ κ³µ                                                         |
| **Main API μ„λ²„**          | μ‹¤μ  API μ‘λ‹µ μ κ³µ                                                                       |
| **Fallback API μ„λ²„**      | μ¥μ•  μ‹ μ‘λ‹µ: `{ status: 'maintenance' }` λ“±μ λ©”μ‹μ§€ λ°ν™                               |
| **μ •μ  Fallback νμ΄μ§€**   | `/maintenance.html` κ°™μ€ νμΌλ΅ μ κ²€ λ©”μ‹μ§€ ν‘μ‹ λ° λ³µκµ¬ κ°μ§€ κΈ°λ¥ ν¬ν•¨                  |

---

### β… μ”μ²­ νλ¦„ λ° μ„¤κ³„ κ°μ”

μ΄ μ „λµμ€ λ¨λ“  ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ΄ HAProxyλ¥Ό ν†µν•΄ μ •μ  μμ› μ„λ²„μ™€ API μ„λ²„λ΅ λΌμ°ν…λκ³ , μ–΄λ ν• μ½μ΄λΌλ„ μ •μƒ μ‘λ‹µμ„ ν•μ§€ λ»ν•  κ²½μ° HAProxyκ°€ `/maintenance.html` μ •μ  νμ΄μ§€λ΅ λΌμ°ν…ν•λ„λ΅ κµ¬μ„±λμ–΄ μλ‹¤. μ΄ fallback νμ΄μ§€λ” ν΄λΌμ΄μ–ΈνΈ λ‹¨μ—μ„ μ„λ²„λ“¤μ μ •μƒ λ³µκµ¬ μ—¬λ¶€λ¥Ό μ£ΌκΈ°μ μΌλ΅ ν™•μΈν•λ©°, λ‘ μ„λ²„ λ¨λ‘ λ³µκµ¬λμ—μ„ λ• μλ™μΌλ΅ μ›λ νμ΄μ§€(`/`)λ΅ μƒλ΅κ³ μΉ¨ν•μ—¬ μµμ‹  μƒνƒλ΅ λ³µκ·€ν•κ² λλ‹¤.

- μ¥μ• κ°€ λ°μƒν•΄λ„ μ‚¬μ©μμ—κ² μ•λ‚΄ λ©”μ‹μ§€λ¥Ό μ κ³µν•κ³ , μλ™ μ΅°μ‘ μ—†μ΄ μλ™μΌλ΅ λ³µκµ¬λ  μ μλ” UX λ³΄μ¥
- ν΄λΌμ΄μ–ΈνΈλ” APIμ™€ μ •μ  νμΌ μ„λ²„λ¥Ό κ°κ° λ³‘λ ¬λ΅ ν—¬μ¤ μ²΄ν¬ν•λ©°, λ‘ λ‹¤ OKμΌ κ²½μ°μ—λ§ λ³µκ·€
- λ³µκ·€ μ‹ `/?v=timestamp` μΏΌλ¦¬λ¥Ό μ¶”κ°€ν•μ—¬ μΊμ‹λ¥Ό λ¬΄ν¨ν™”ν•κ³  μµμ‹  μ •μ  μμ‚° λ΅λ”©μ„ μ λ„

---

### β… fallback μ •μ  νμ΄μ§€ λ‚΄ JS μ½”λ“ μμ‹

```html
<script>
  async function checkRecovery() {
    const [apiOk, staticOk] = await Promise.all([
      fetch("/api/healthz", { cache: "no-store" })
        .then((res) => res.ok)
        .catch(() => false),

      fetch("/healthz", { cache: "no-store" })
        .then((res) => res.ok)
        .catch(() => false),
    ]);

    if (apiOk && staticOk) {
      location.href = "/?v=" + Date.now();
    }
  }

  setInterval(checkRecovery, 5000);
</script>
```

---

### β… μ¥μ•  λ€μ‘ μ „λµ

| μ¥μ•  μ ν•                    | λ€μ‘ λ°©μ‹                                                             |
| ---------------------------- | --------------------------------------------------------------------- |
| μ •μ  μ„λ²„ λλ” API μ„λ²„ λ‹¤μ΄ | HAProxyκ°€ `/maintenance.html`λ΅ λΌμ°ν…                                |
| fallback μ •μ  νμ΄μ§€ μ§„μ… ν›„ | JSμ—μ„ `/api/healthz` + `/healthz` λ³‘λ ¬ μ²΄ν¬ β†’ λ³µκµ¬λλ©΄ μλ™ μƒλ΅κ³ μΉ¨ |

---

### β… Fallback HTMLμ λ³µκµ¬ μ²λ¦¬ λ΅μ§

- **μ •μ  μ„λ²„μ™€ API μ„λ²„κ°€ λ¨λ‘ μ‚΄μ•„μλ” μƒνƒλ¥Ό ν™•μΈν•΄μ•Όλ§ μλ™ λ³µκ·€**
- μ •μ  νμ΄μ§€ μμ²΄κ°€ μµμ‹  μƒνƒλ΅ λ‹¤μ‹ λ΅λ“λλ„λ΅ `/?v=timestamp` μΏΌλ¦¬ μ¶”κ°€

---

### β… HAProxy μ„¤μ • μμ‹

```haproxy
frontend http-in
    bind *:80
    acl is_api path_beg /api
    use_backend api_backend if is_api
    default_backend static_backend

backend api_backend
    option httpchk GET /healthz
    server main_api 10.0.0.10:8080 check
    server fallback_api 10.0.0.11:8080 backup

backend static_backend
    option httpchk GET /healthz
    server main_static 10.0.0.20:80 check
    server fallback_static 10.0.0.21:80 backup
```

---

### β… μ£Όμ” μ‹λ‚λ¦¬μ¤λ³„ ν”λ΅μ° μ •λ¦¬

#### π“ μ •μƒ μƒνƒ

- `/` μ”μ²­ β†’ Nginx β†’ index.html μ κ³µ
- `/api/data` β†’ API μ„λ²„ μ •μƒ μ‘λ‹µ

#### π“ API λλ” μ •μ  μ„λ²„ μ¤‘ ν•λ‚λΌλ„ λ‹¤μ΄λ¨

- HAProxyκ°€ `/maintenance.html`λ΅ λΌμ°ν…
- JSμ—μ„ μƒνƒ ν™•μΈ μ¤‘, λ³µκµ¬λλ©΄ μλ™ μƒλ΅κ³ μΉ¨

#### π“ μ¬λ°°ν¬ ν›„ λ³µκµ¬λ¨

- JSκ°€ `/healthz`, `/api/healthz`μ—μ„ λ¨λ‘ OK μ‘λ‹µ ν™•μΈ
- location.href = `/?v=timestamp` νΈμ¶λ΅ μµμ‹  νμ΄μ§€ μλ™ λ΅λ”©

---

### β… λ°°ν¬ μ „λµ μ”μ•½

- μ¥μ• κ°€ λ°μƒν•λ©΄ λ¬΄μ΅°κ±΄ fallback μ •μ  νμ΄μ§€λ΅ μ§„μ…μ‹μΌ, λ³µκµ¬ μ‹μ μ€ ν΄λΌμ΄μ–ΈνΈ JSκ°€ νλ‹¨
- `/maintenance.html`μ—μ„ μ •μ  μ„λ²„μ™€ API μ„λ²„ μƒνƒλ¥Ό λ³‘λ ¬λ΅ ν™•μΈν•΄ μλ™ λ³µκµ¬ μ²λ¦¬
- λ¨λ“  μ”μ²­μ€ λ°λ“μ‹ HAProxyλ¥Ό κ±°μΉλ©° μƒνƒ κΈ°λ° λΌμ°ν…
- λ³µκµ¬ μ‹ μ •μ  μΊμ‹ λ¬΄ν¨ν™”λ¥Ό μ„ν•΄ `location.href = '/?v=' + Date.now()` λ°©μ‹ μ‚¬μ©
